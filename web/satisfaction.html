<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æ»¡æ„åº¦è¯„ä»· - Servify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .satisfaction-form {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      width: 100%;
      max-width: 600px;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .form-header h1 {
      color: #2d3748;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .form-header p {
      color: #718096;
      font-size: 16px;
    }

    .ticket-info {
      background: #f7fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border-left: 4px solid #4299e1;
    }

    .ticket-info h3 {
      color: #2d3748;
      margin-bottom: 8px;
    }

    .ticket-info p {
      color: #718096;
      margin: 4px 0;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .rating-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .star-rating {
      display: flex;
      gap: 4px;
    }

    .star {
      font-size: 32px;
      color: #e2e8f0;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .star:hover,
    .star.active {
      color: #f6ad55;
      transform: scale(1.1);
    }

    .rating-text {
      font-size: 14px;
      color: #718096;
      margin-left: 10px;
      font-weight: 500;
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      color: #2d3748;
      transition: border-color 0.2s ease;
    }

    .form-select:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
      transition: border-color 0.2s ease;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .form-textarea::placeholder {
      color: #a0aec0;
    }

    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      border: none;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(66, 153, 225, 0.3);
    }

    .submit-button:active {
      transform: translateY(0);
    }

    .submit-button:disabled {
      background: #a0aec0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .success-message,
    .error-message {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      text-align: center;
    }

    .success-message {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .error-message {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .loading {
      text-align: center;
      color: #718096;
      font-style: italic;
    }

    @media (max-width: 640px) {
      .satisfaction-form {
        padding: 30px 20px;
      }

      .form-header h1 {
        font-size: 24px;
      }

      .star {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="satisfaction-form">
    <div class="form-header">
      <h1>ğŸŒŸ å®¢æˆ·æ»¡æ„åº¦è¯„ä»·</h1>
      <p>æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬å¾ˆé‡è¦ï¼Œè¯·ä¸ºæœ¬æ¬¡æœåŠ¡ä½“éªŒæ‰“åˆ†</p>
    </div>

    <div id="loading" class="loading">
      æ­£åœ¨åŠ è½½å·¥å•ä¿¡æ¯...
    </div>

    <div id="error-message" class="error-message" style="display: none;"></div>

    <form id="satisfaction-form" style="display: none;">
      <div class="ticket-info">
        <h3>å·¥å•ä¿¡æ¯</h3>
        <p><strong>å·¥å•æ ‡é¢˜:</strong> <span id="ticket-title">-</span></p>
        <p><strong>å·¥å•ç¼–å·:</strong> #<span id="ticket-id">-</span></p>
        <p><strong>å¤„ç†å®¢æœ:</strong> <span id="agent-name">-</span></p>
        <p><strong>è§£å†³æ—¶é—´:</strong> <span id="resolved-time">-</span></p>
      </div>

      <div class="form-group">
        <label for="rating">æ•´ä½“æ»¡æ„åº¦ <span style="color: #e53e3e;">*</span></label>
        <div class="rating-container">
          <div class="star-rating" id="star-rating">
            <span class="star" data-rating="1">â˜…</span>
            <span class="star" data-rating="2">â˜…</span>
            <span class="star" data-rating="3">â˜…</span>
            <span class="star" data-rating="4">â˜…</span>
            <span class="star" data-rating="5">â˜…</span>
          </div>
          <span class="rating-text" id="rating-text">è¯·é€‰æ‹©è¯„åˆ†</span>
        </div>
      </div>

      <div class="form-group">
        <label for="category">è¯„ä»·ç±»å‹</label>
        <select id="category" class="form-select">
          <option value="overall">æ•´ä½“æ»¡æ„åº¦</option>
          <option value="service_quality">æœåŠ¡è´¨é‡</option>
          <option value="response_time">å“åº”é€Ÿåº¦</option>
          <option value="resolution_quality">é—®é¢˜è§£å†³è´¨é‡</option>
        </select>
      </div>

      <div class="form-group">
        <label for="comment">è¯¦ç»†åé¦ˆ</label>
        <textarea
          id="comment"
          class="form-textarea"
          placeholder="è¯·åˆ†äº«æ‚¨å¯¹æœ¬æ¬¡æœåŠ¡çš„å…·ä½“æ„è§å’Œå»ºè®®ï¼Œæ‚¨çš„åé¦ˆå°†å¸®åŠ©æˆ‘ä»¬æŒç»­æ”¹è¿›æœåŠ¡è´¨é‡..."
        ></textarea>
      </div>

      <button type="submit" class="submit-button" id="submit-btn">
        æäº¤è¯„ä»·
      </button>
    </form>

    <div id="success-message" class="success-message" style="display: none;">
      <h3>ğŸ‰ æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼</h3>
      <p>æ‚¨çš„è¯„ä»·å·²æˆåŠŸæäº¤ï¼Œæˆ‘ä»¬å°†è®¤çœŸå¯¹å¾…æ‚¨çš„æ¯ä¸€æ¡å»ºè®®ã€‚</p>
    </div>
  </div>

  <script>
    // è·å–URLå‚æ•°
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // æ˜Ÿçº§è¯„åˆ†ç»„ä»¶
    class StarRating {
      constructor(container) {
        this.container = container;
        this.stars = container.querySelectorAll('.star');
        this.ratingText = document.getElementById('rating-text');
        this.currentRating = 0;
        this.ratingTexts = {
          0: 'è¯·é€‰æ‹©è¯„åˆ†',
          1: 'å¾ˆä¸æ»¡æ„',
          2: 'ä¸æ»¡æ„',
          3: 'ä¸€èˆ¬',
          4: 'æ»¡æ„',
          5: 'éå¸¸æ»¡æ„'
        };

        this.init();
      }

      init() {
        this.stars.forEach(star => {
          star.addEventListener('click', () => {
            this.setRating(parseInt(star.dataset.rating));
          });

          star.addEventListener('mouseenter', () => {
            this.highlightStars(parseInt(star.dataset.rating));
          });
        });

        this.container.addEventListener('mouseleave', () => {
          this.highlightStars(this.currentRating);
        });
      }

      setRating(rating) {
        this.currentRating = rating;
        this.highlightStars(rating);
        this.ratingText.textContent = this.ratingTexts[rating];
      }

      highlightStars(rating) {
        this.stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add('active');
          } else {
            star.classList.remove('active');
          }
        });
      }

      getRating() {
        return this.currentRating;
      }
    }

    // API å®¢æˆ·ç«¯
    class ApiClient {
      constructor(baseUrl = '/api') {
        this.baseUrl = baseUrl;
      }

      async request(endpoint, options = {}) {
        const url = `${this.baseUrl}${endpoint}`;
        const response = await fetch(url, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: 'Network error' }));
          throw new Error(error.message || `HTTP ${response.status}`);
        }

        return response.json();
      }

      async getTicket(ticketId) {
        return this.request(`/tickets/${ticketId}`);
      }

      async getTicketSatisfaction(ticketId) {
        try {
          return await this.request(`/tickets/${ticketId}/satisfaction`);
        } catch (error) {
          if (error.message.includes('404')) {
            return null; // è¿˜æ²¡æœ‰è¯„ä»·
          }
          throw error;
        }
      }

      async createSatisfaction(data) {
        return this.request('/satisfactions', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      }
    }

    // ä¸»åº”ç”¨
    class SatisfactionApp {
      constructor() {
        this.api = new ApiClient();
        this.starRating = new StarRating(document.getElementById('star-rating'));
        this.ticketId = getUrlParameter('ticket_id');
        this.customerId = getUrlParameter('customer_id');

        this.loadingEl = document.getElementById('loading');
        this.errorMessageEl = document.getElementById('error-message');
        this.formEl = document.getElementById('satisfaction-form');
        this.successMessageEl = document.getElementById('success-message');

        this.init();
      }

      async init() {
        if (!this.ticketId || !this.customerId) {
          this.showError('ç¼ºå°‘å¿…è¦å‚æ•°ï¼šå·¥å•IDæˆ–å®¢æˆ·ID');
          return;
        }

        try {
          await this.loadTicketInfo();
          await this.checkExistingSatisfaction();
          this.setupForm();
          this.showForm();
        } catch (error) {
          this.showError(`åŠ è½½å¤±è´¥ï¼š${error.message}`);
        }
      }

      async loadTicketInfo() {
        const ticket = await this.api.getTicket(this.ticketId);

        document.getElementById('ticket-title').textContent = ticket.title || '-';
        document.getElementById('ticket-id').textContent = ticket.id || '-';
        document.getElementById('agent-name').textContent = ticket.agent?.name || 'ç³»ç»Ÿå¤„ç†';
        document.getElementById('resolved-time').textContent = ticket.resolved_at
          ? new Date(ticket.resolved_at).toLocaleString('zh-CN')
          : '-';

        this.ticketData = ticket;
      }

      async checkExistingSatisfaction() {
        const satisfaction = await this.api.getTicketSatisfaction(this.ticketId);
        if (satisfaction) {
          this.showSuccess('æ‚¨å·²ç»å¯¹æ­¤å·¥å•è¿›è¡Œè¿‡è¯„ä»·ï¼Œæ„Ÿè°¢æ‚¨çš„åé¦ˆï¼');
          throw new Error('Already rated');
        }
      }

      setupForm() {
        const form = document.getElementById('satisfaction-form');
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.submitSatisfaction();
        });
      }

      async submitSatisfaction() {
        const submitBtn = document.getElementById('submit-btn');
        const rating = this.starRating.getRating();

        if (!rating) {
          this.showError('è¯·é€‰æ‹©æ»¡æ„åº¦è¯„åˆ†');
          return;
        }

        const data = {
          ticket_id: parseInt(this.ticketId),
          customer_id: parseInt(this.customerId),
          agent_id: this.ticketData.agent_id || null,
          rating: rating,
          category: document.getElementById('category').value,
          comment: document.getElementById('comment').value.trim()
        };

        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'æäº¤ä¸­...';

          await this.api.createSatisfaction(data);
          this.showSuccess();
        } catch (error) {
          this.showError(`æäº¤å¤±è´¥ï¼š${error.message}`);
          submitBtn.disabled = false;
          submitBtn.textContent = 'æäº¤è¯„ä»·';
        }
      }

      showForm() {
        this.loadingEl.style.display = 'none';
        this.formEl.style.display = 'block';
      }

      showError(message) {
        this.loadingEl.style.display = 'none';
        this.formEl.style.display = 'none';
        this.errorMessageEl.textContent = message;
        this.errorMessageEl.style.display = 'block';
      }

      showSuccess(message = null) {
        this.loadingEl.style.display = 'none';
        this.formEl.style.display = 'none';
        this.errorMessageEl.style.display = 'none';

        if (message) {
          this.successMessageEl.querySelector('p').textContent = message;
        }
        this.successMessageEl.style.display = 'block';
      }
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      new SatisfactionApp();
    });
  </script>
</body>
</html>