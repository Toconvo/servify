//line /Users/cui/Workspaces/servify/internal/services/ai_enhanced.go:1:1
package services

import (
	"context"
	"fmt"
	"strings"
	"time"

	"github.com/sirupsen/logrus"
	"servify/internal/models"
	"servify/pkg/weknora"
)

// EnhancedAIService WeKnora é›†æˆçš„å¢žå¼º AI æœåŠ¡
type EnhancedAIService struct {
	// ç»§æ‰¿åŽŸæœ‰ AIService
	*AIService

	// WeKnora ç›¸å…³
	weKnoraClient   weknora.WeKnoraInterface
	weKnoraEnabled  bool
	knowledgeBaseID string

	// é™çº§å’Œç›‘æŽ§
	fallbackEnabled bool
	circuitBreaker  *CircuitBreaker
	metrics         *AIMetrics

	logger *logrus.Logger
}

// AIMetrics AI æœåŠ¡æŒ‡æ ‡
type AIMetrics struct {
	QueryCount          int64         `json:"query_count"`
	SuccessCount        int64         `json:"success_count"`
	WeKnoraUsageCount   int64         `json:"weknora_usage_count"`
	FallbackUsageCount  int64         `json:"fallback_usage_count"`
	AverageLatency      time.Duration `json:"average_latency"`
	WeKnoraLatency      time.Duration `json:"weknora_latency"`
	OpenAILatency       time.Duration `json:"openai_latency"`
}

// EnhancedAIResponse å¢žå¼ºçš„ AI å“åº”
type EnhancedAIResponse struct {
	*AIResponse
	Sources     []weknora.SearchResult `json:"sources,omitempty"`
	Strategy    string                 `json:"strategy"`    // "weknora", "fallback", "hybrid"
	Duration    time.Duration          `json:"duration"`
	TokensUsed  int                    `json:"tokens_used,omitempty"`
}

// NewEnhancedAIService åˆ›å»ºå¢žå¼ºçš„ AI æœåŠ¡
func NewEnhancedAIService(
	originalService *AIService,
	weKnoraClient weknora.WeKnoraInterface,
	knowledgeBaseID string,
	logger *logrus.Logger,
) *EnhancedAIService {goCover_649b36dcf066__26[0] = 3 ; goCover_649b36dcf066__26[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__26[2] = 26 ; goCover_649b36dcf066__26[3] = 1;
	if logger == nil {goCover_649b36dcf066__26[5] = 1;
		logger = logrus.New()
	}

	goCover_649b36dcf066__26[4] = 1;return &EnhancedAIService{
		AIService:       originalService,
		weKnoraClient:   weKnoraClient,
		weKnoraEnabled:  weKnoraClient != nil,
		knowledgeBaseID: knowledgeBaseID,
		fallbackEnabled: true,
		circuitBreaker:  NewCircuitBreaker(),
		metrics:         &AIMetrics{},
		logger:          logger,
	}
}

// ProcessQueryEnhanced å¢žå¼ºçš„æŸ¥è¯¢å¤„ç†
func (s *EnhancedAIService) ProcessQueryEnhanced(ctx context.Context, query string, sessionID string) (*EnhancedAIResponse, error) {goCover_649b36dcf066__27[0] = 10 ; goCover_649b36dcf066__27[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__27[2] = 27 ; goCover_649b36dcf066__27[3] = 1;
	startTime := time.Now()
	s.metrics.QueryCount++

	// æ£€æŸ¥æ˜¯å¦éœ€è¦è½¬äººå·¥
	if s.ShouldTransferToHuman(query, nil) {goCover_649b36dcf066__27[8] = 1;
		return &EnhancedAIResponse{
			AIResponse: &AIResponse{
				Content:    "æˆ‘æ¥ä¸ºæ‚¨è½¬æŽ¥äººå·¥å®¢æœï¼Œè¯·ç¨ç­‰...",
				Source:     "system",
				Confidence: 1.0,
			},
			Strategy: "transfer",
			Duration: time.Since(startTime),
		}, nil
	}

	// çŸ¥è¯†æ£€ç´¢
	goCover_649b36dcf066__27[4] = 1;docs, strategy, err := s.retrieveKnowledge(ctx, query)
	if err != nil {goCover_649b36dcf066__27[9] = 1;
		s.logger.Errorf("Knowledge retrieval failed: %v", err)
		// ç»§ç»­å¤„ç†ï¼Œä½¿ç”¨ç©ºæ–‡æ¡£
		docs = []models.KnowledgeDoc{}
		strategy = "fallback"
	}

	// æž„å»ºå¢žå¼º prompt
	goCover_649b36dcf066__27[5] = 1;prompt := s.buildEnhancedPrompt(query, docs)

	// è°ƒç”¨ OpenAI
	response, err := s.callOpenAI(ctx, prompt)
	if err != nil {goCover_649b36dcf066__27[10] = 1;
		s.logger.Errorf("OpenAI call failed: %v", err)
		// ä½¿ç”¨é™çº§å“åº”
		response = s.getFallbackResponse(query)
		strategy = "fallback"
	} else{ goCover_649b36dcf066__27[11] = 1;{
		s.metrics.SuccessCount++
	}}

	goCover_649b36dcf066__27[6] = 1;duration := time.Since(startTime)
	s.metrics.AverageLatency = (s.metrics.AverageLatency + duration) / 2

	// æž„å»ºå“åº”
	enhancedResp := &EnhancedAIResponse{
		AIResponse: &AIResponse{
			Content:    response,
			Source:     "ai",
			Confidence: s.calculateConfidence(docs, strategy),
		},
		Strategy: strategy,
		Duration: duration,
	}

	// å¦‚æžœä½¿ç”¨äº† WeKnoraï¼Œæ·»åŠ æ¥æºä¿¡æ¯
	if strategy == "weknora" || strategy == "hybrid" {goCover_649b36dcf066__27[12] = 1;
		enhancedResp.Sources = s.convertDocsToSources(docs)
	}

	goCover_649b36dcf066__27[7] = 1;return enhancedResp, nil
}

// retrieveKnowledge çŸ¥è¯†æ£€ç´¢ï¼ˆWeKnora + é™çº§ï¼‰
func (s *EnhancedAIService) retrieveKnowledge(ctx context.Context, query string) ([]models.KnowledgeDoc, string, error) {goCover_649b36dcf066__28[0] = 8 ; goCover_649b36dcf066__28[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__28[2] = 28 ; goCover_649b36dcf066__28[3] = 1;
	// å°è¯• WeKnora æ£€ç´¢
	if s.weKnoraEnabled && s.circuitBreaker.Allow() {goCover_649b36dcf066__28[6] = 1;
		docs, err := s.searchWithWeKnora(ctx, query)
		if err == nil && len(docs) > 0 {goCover_649b36dcf066__28[8] = 1;
			s.circuitBreaker.OnSuccess()
			s.metrics.WeKnoraUsageCount++
			s.logger.Infof("WeKnora search succeeded, found %d documents", len(docs))
			return docs, "weknora", nil
		}

		goCover_649b36dcf066__28[7] = 1;if err != nil {goCover_649b36dcf066__28[9] = 1;
			s.circuitBreaker.OnFailure()
			s.logger.Warnf("WeKnora search failed: %v", err)
		}
	}

	// é™çº§åˆ°åŽŸçŸ¥è¯†åº“
	goCover_649b36dcf066__28[4] = 1;if s.fallbackEnabled {goCover_649b36dcf066__28[10] = 1;
		s.logger.Info("Using fallback knowledge base")
		docs := s.knowledgeBase.Search(query, 3)
		s.metrics.FallbackUsageCount++
		return docs, "fallback", nil
	}

	goCover_649b36dcf066__28[5] = 1;return []models.KnowledgeDoc{}, "none", fmt.Errorf("all knowledge sources unavailable")
}

// searchWithWeKnora ä½¿ç”¨ WeKnora æœç´¢
func (s *EnhancedAIService) searchWithWeKnora(ctx context.Context, query string) ([]models.KnowledgeDoc, error) {goCover_649b36dcf066__29[0] = 7 ; goCover_649b36dcf066__29[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__29[2] = 29 ; goCover_649b36dcf066__29[3] = 1;
	startTime := time.Now()

	searchReq := &weknora.SearchRequest{
		Query:           query,
		KnowledgeBaseID: s.knowledgeBaseID,
		Limit:           5,
		Threshold:       0.7,
		Strategy:        "hybrid", // ä½¿ç”¨æ··åˆæ£€ç´¢ç­–ç•¥
	}

	response, err := s.weKnoraClient.SearchKnowledge(ctx, searchReq)
	if err != nil {goCover_649b36dcf066__29[7] = 1;
		return nil, fmt.Errorf("WeKnora search error: %w", err)
	}

	goCover_649b36dcf066__29[4] = 1;s.metrics.WeKnoraLatency = time.Since(startTime)

	if !response.Success {goCover_649b36dcf066__29[8] = 1;
		return nil, fmt.Errorf("WeKnora API error: %s", response.Message)
	}

	// è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼
	goCover_649b36dcf066__29[5] = 1;var docs []models.KnowledgeDoc
	for _, result := range response.Data.Results {goCover_649b36dcf066__29[9] = 1;
		doc := models.KnowledgeDoc{
			// IDä¼šç”±æ•°æ®åº“è‡ªåŠ¨åˆ†é…ï¼Œä¸ä»ŽWeKnoraçš„DocumentIDè®¾ç½®
			Title:    result.Title,
			Content:  result.Content,
			Category: "weknora",
			Tags:     "weknora,search",
		}
		docs = append(docs, doc)
	}

	goCover_649b36dcf066__29[6] = 1;return docs, nil
}

// buildEnhancedPrompt æž„å»ºå¢žå¼ºçš„æç¤ºè¯
func (s *EnhancedAIService) buildEnhancedPrompt(query string, docs []models.KnowledgeDoc) string {goCover_649b36dcf066__30[0] = 5 ; goCover_649b36dcf066__30[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__30[2] = 30 ; goCover_649b36dcf066__30[3] = 1;
	var prompt strings.Builder

	prompt.WriteString("ä½ æ˜¯ Servify æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œè¯·æ ¹æ®ä»¥ä¸‹çŸ¥è¯†åº“ä¿¡æ¯å›žç­”ç”¨æˆ·é—®é¢˜ã€‚\n\n")

	if len(docs) > 0 {goCover_649b36dcf066__30[5] = 1;
		prompt.WriteString("ðŸ” ç›¸å…³çŸ¥è¯†åº“ä¿¡æ¯ï¼š\n")
		for i, doc := range docs {goCover_649b36dcf066__30[6] = 1;
			prompt.WriteString(fmt.Sprintf("%d. ðŸ“„ %s\n", i+1, doc.Title))
			prompt.WriteString(fmt.Sprintf("   ðŸ“ %s\n\n", doc.Content))
		}
	} else{ goCover_649b36dcf066__30[7] = 1;{
		prompt.WriteString("â„¹ï¸ æ³¨æ„ï¼šå½“å‰æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„çŸ¥è¯†åº“ä¿¡æ¯ï¼Œè¯·åŸºäºŽä¸€èˆ¬å¸¸è¯†å›žç­”ã€‚\n\n")
	}}

	goCover_649b36dcf066__30[4] = 1;prompt.WriteString("ðŸ“‹ å›žç­”è¦æ±‚ï¼š\n")
	prompt.WriteString("1. âœ… ä¼˜å…ˆåŸºäºŽçŸ¥è¯†åº“ä¿¡æ¯æä¾›å‡†ç¡®å›žç­”\n")
	prompt.WriteString("2. ðŸ” å¦‚æžœçŸ¥è¯†åº“ä¿¡æ¯ä¸è¶³ï¼Œè¯·è¯šå®žè¯´æ˜Žå¹¶æä¾›ä¸€èˆ¬æ€§å»ºè®®\n")
	prompt.WriteString("3. ðŸ˜Š ä¿æŒå‹å¥½ã€ä¸“ä¸šçš„è¯­æ°”\n")
	prompt.WriteString("4. ðŸ†˜ å¦‚æžœé—®é¢˜è¶…å‡ºèƒ½åŠ›èŒƒå›´ï¼Œå»ºè®®è½¬äººå·¥å®¢æœ\n")
	prompt.WriteString("5. ðŸŽ¯ å›žç­”è¦ç®€æ´æ˜Žäº†ï¼Œé¿å…å†—é•¿\n\n")

	prompt.WriteString(fmt.Sprintf("â“ ç”¨æˆ·é—®é¢˜ï¼š%s\n\n", query))
	prompt.WriteString("ðŸ’¬ è¯·ç”¨ä¸­æ–‡å›žç­”ï¼š")

	return prompt.String()
}

// calculateConfidence è®¡ç®—ç½®ä¿¡åº¦
func (s *EnhancedAIService) calculateConfidence(docs []models.KnowledgeDoc, strategy string) float64 {goCover_649b36dcf066__31[0] = 13 ; goCover_649b36dcf066__31[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__31[2] = 31 ; goCover_649b36dcf066__31[3] = 1;
	baseConfidence := 0.5

	switch strategy {
	case "weknora":goCover_649b36dcf066__31[8] = 1;
		baseConfidence = 0.8
	case "fallback":goCover_649b36dcf066__31[9] = 1;
		baseConfidence = 0.6
	case "none":goCover_649b36dcf066__31[10] = 1;
		baseConfidence = 0.3
	}

	// æ ¹æ®æ–‡æ¡£æ•°é‡è°ƒæ•´ç½®ä¿¡åº¦
	goCover_649b36dcf066__31[4] = 1;if len(docs) > 0 {goCover_649b36dcf066__31[11] = 1;
		docBonus := float64(len(docs)) * 0.05
		if docBonus > 0.15 {goCover_649b36dcf066__31[13] = 1;
			docBonus = 0.15
		}
		goCover_649b36dcf066__31[12] = 1;baseConfidence += docBonus
	}

	// ç¡®ä¿ç½®ä¿¡åº¦åœ¨åˆç†èŒƒå›´å†…
	goCover_649b36dcf066__31[5] = 1;if baseConfidence > 0.95 {goCover_649b36dcf066__31[14] = 1;
		baseConfidence = 0.95
	}
	goCover_649b36dcf066__31[6] = 1;if baseConfidence < 0.1 {goCover_649b36dcf066__31[15] = 1;
		baseConfidence = 0.1
	}

	goCover_649b36dcf066__31[7] = 1;return baseConfidence
}

// convertDocsToSources è½¬æ¢æ–‡æ¡£ä¸ºæ¥æºä¿¡æ¯
func (s *EnhancedAIService) convertDocsToSources(docs []models.KnowledgeDoc) []weknora.SearchResult {goCover_649b36dcf066__32[0] = 3 ; goCover_649b36dcf066__32[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__32[2] = 32 ; goCover_649b36dcf066__32[3] = 1;
	var sources []weknora.SearchResult
	for _, doc := range docs {goCover_649b36dcf066__32[5] = 1;
		source := weknora.SearchResult{
			DocumentID: fmt.Sprintf("%d", doc.ID), // è½¬æ¢uintä¸ºstring
			Title:      doc.Title,
			Content:    doc.Content,
			Score:      0.8, // é»˜è®¤åˆ†æ•°
			Source:     "knowledge_base",
		}
		sources = append(sources, source)
	}
	goCover_649b36dcf066__32[4] = 1;return sources
}

// UploadDocumentToWeKnora ä¸Šä¼ æ–‡æ¡£åˆ° WeKnora
func (s *EnhancedAIService) UploadDocumentToWeKnora(ctx context.Context, title, content string, tags []string) error {goCover_649b36dcf066__33[0] = 5 ; goCover_649b36dcf066__33[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__33[2] = 33 ; goCover_649b36dcf066__33[3] = 1;
	if !s.weKnoraEnabled {goCover_649b36dcf066__33[6] = 1;
		return fmt.Errorf("WeKnora is not enabled")
	}

	goCover_649b36dcf066__33[4] = 1;doc := &weknora.Document{
		Type:    "text",
		Title:   title,
		Content: content,
		Tags:    tags,
	}

	_, err := s.weKnoraClient.UploadDocument(ctx, s.knowledgeBaseID, doc)
	if err != nil {goCover_649b36dcf066__33[7] = 1;
		return fmt.Errorf("failed to upload document to WeKnora: %w", err)
	}

	goCover_649b36dcf066__33[5] = 1;s.logger.Infof("Successfully uploaded document '%s' to WeKnora", title)
	return nil
}

// GetMetrics èŽ·å–æœåŠ¡æŒ‡æ ‡
func (s *EnhancedAIService) GetMetrics() *AIMetrics {goCover_649b36dcf066__34[0] = 1 ; goCover_649b36dcf066__34[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__34[2] = 34 ; goCover_649b36dcf066__34[3] = 1;
	return s.metrics
}

// GetStatus èŽ·å–æœåŠ¡çŠ¶æ€
func (s *EnhancedAIService) GetStatus(ctx context.Context) map[string]interface{} {goCover_649b36dcf066__35[0] = 6 ; goCover_649b36dcf066__35[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__35[2] = 35 ; goCover_649b36dcf066__35[3] = 1;
	status := map[string]interface{}{
		"weknora_enabled":  s.weKnoraEnabled,
		"fallback_enabled": s.fallbackEnabled,
		"metrics":          s.metrics,
	}

    // æ£€æŸ¥ WeKnora å¥åº·çŠ¶æ€
    if s.weKnoraEnabled {goCover_649b36dcf066__35[5] = 1;
        if s.weKnoraClient != nil {goCover_649b36dcf066__35[6] = 1;
            err := s.weKnoraClient.HealthCheck(ctx)
            status["weknora_healthy"] = err == nil
            if err != nil {goCover_649b36dcf066__35[7] = 1;
                status["weknora_error"] = err.Error()
            }
        } else{ goCover_649b36dcf066__35[8] = 1;{
            status["weknora_healthy"] = false
            status["weknora_error"] = "weknora client not initialized"
        }}
    }

	// ç†”æ–­å™¨çŠ¶æ€
	goCover_649b36dcf066__35[4] = 1;status["circuit_breaker"] = map[string]interface{}{
		"state":         s.circuitBreaker.State(),
		"failure_count": s.circuitBreaker.FailureCount(),
	}

	return status
}

// SetWeKnoraEnabled åŠ¨æ€å¼€å¯/å…³é—­ WeKnora
func (s *EnhancedAIService) SetWeKnoraEnabled(enabled bool) {goCover_649b36dcf066__36[0] = 1 ; goCover_649b36dcf066__36[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__36[2] = 36 ; goCover_649b36dcf066__36[3] = 1;
	s.weKnoraEnabled = enabled
	s.logger.Infof("WeKnora enabled set to: %v", enabled)
}

// SetFallbackEnabled åŠ¨æ€å¼€å¯/å…³é—­é™çº§
func (s *EnhancedAIService) SetFallbackEnabled(enabled bool) {goCover_649b36dcf066__37[0] = 1 ; goCover_649b36dcf066__37[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__37[2] = 37 ; goCover_649b36dcf066__37[3] = 1;
	s.fallbackEnabled = enabled
	s.logger.Infof("Fallback enabled set to: %v", enabled)
}

// ResetCircuitBreaker é‡ç½®ç†”æ–­å™¨
func (s *EnhancedAIService) ResetCircuitBreaker() {goCover_649b36dcf066__38[0] = 1 ; goCover_649b36dcf066__38[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__38[2] = 38 ; goCover_649b36dcf066__38[3] = 1;
	s.circuitBreaker.Reset()
	s.logger.Info("Circuit breaker reset")
}

// SyncKnowledgeBase åŒæ­¥çŸ¥è¯†åº“ï¼ˆä»ŽåŽŸçŸ¥è¯†åº“åˆ° WeKnoraï¼‰
func (s *EnhancedAIService) SyncKnowledgeBase(ctx context.Context) error {goCover_649b36dcf066__39[0] = 9 ; goCover_649b36dcf066__39[1] = goCover_649b36dcf066_P ; goCover_649b36dcf066__39[2] = 39 ; goCover_649b36dcf066__39[3] = 1;
	if !s.weKnoraEnabled {goCover_649b36dcf066__39[7] = 1;
		return fmt.Errorf("WeKnora is not enabled")
	}

	goCover_649b36dcf066__39[4] = 1;s.logger.Info("Starting knowledge base synchronization...")

	// èŽ·å–åŽŸçŸ¥è¯†åº“çš„æ‰€æœ‰æ–‡æ¡£
	docs := s.knowledgeBase.documents
	successCount := 0
	errorCount := 0

	for _, doc := range docs {goCover_649b36dcf066__39[8] = 1;
		err := s.UploadDocumentToWeKnora(ctx, doc.Title, doc.Content, strings.Split(doc.Tags, ","))
		if err != nil {goCover_649b36dcf066__39[9] = 1;
			s.logger.Errorf("Failed to sync document '%s': %v", doc.Title, err)
			errorCount++
		} else{ goCover_649b36dcf066__39[10] = 1;{
			successCount++
		}}
	}

	goCover_649b36dcf066__39[5] = 1;s.logger.Infof("Knowledge base sync completed: %d success, %d errors", successCount, errorCount)

	if errorCount > 0 {goCover_649b36dcf066__39[11] = 1;
		return fmt.Errorf("sync completed with %d errors", errorCount)
	}

	goCover_649b36dcf066__39[6] = 1;return nil
}
