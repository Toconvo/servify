<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Servify 知识库</title>
    <style>
      :root {
        color-scheme: light;
        --brand-primary: #4299e1;
        --brand-secondary: #764ba2;
        --bg: #0b1020;
        --fg: #e8ecff;
      }
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 0; background: var(--bg); color: var(--fg); }
      header { padding: 20px 16px; background: linear-gradient(135deg, color-mix(in srgb, var(--brand-primary) 45%, #0b1020), var(--bg)); border-bottom: 1px solid rgba(255,255,255,.08); }
      header h1 { margin:0; font-size: 18px; }
      header p { margin:6px 0 0; color: rgba(232,236,255,.75); font-size: 13px; }
      .topbar { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .lang { font-size: 12px; color: rgba(232,236,255,.8); }
      .lang a { color: rgba(232,236,255,.9); }
      main { max-width: 960px; margin: 0 auto; padding: 16px; }
      .row { display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0 16px; }
      input, select, button { border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color:#e8ecff; padding: 10px 12px; font-size: 14px; }
      input { flex: 1 1 360px; }
      select { flex: 0 0 200px; }
      button { cursor:pointer; }
      button:hover { background: rgba(255,255,255,.10); }
      .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
      @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
      .card { padding: 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); }
      .card h3 { margin:0 0 8px; font-size: 16px; }
      .meta { font-size: 12px; color: rgba(232,236,255,.7); margin-bottom: 10px; }
      .content { white-space: pre-wrap; font-size: 13px; color: rgba(232,236,255,.86); max-height: 220px; overflow:auto; padding-right: 6px; }
      .tags { margin-top: 10px; font-size: 12px; color: rgba(232,236,255,.7); }
      .err { color: #ffb4b4; font-size: 13px; margin: 10px 0; }
      a { color: #9fb7ff; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <h1 id="h1">Servify 知识库（Public Portal）</h1>
        <div class="lang">
          <a id="lang-zh" href="?lang=zh-CN">中文</a> · <a id="lang-en" href="?lang=en-US">EN</a>
        </div>
      </div>
      <p id="desc">数据来自 `GET /public/kb/docs`，支持关键词搜索与分类过滤。</p>
    </header>
    <main>
      <div class="row">
        <input id="q" placeholder="搜索：标题/内容/标签（search）" />
        <input id="category" placeholder="分类（category，可选）" style="flex:0 0 220px;" />
        <button id="btn">搜索</button>
      </div>
      <div id="err" class="err" style="display:none;"></div>
      <div id="list" class="grid"></div>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);
      const listEl = $("list");
      const errEl = $("err");

      const I18N = {
        "zh-CN": {
          title: (brand) => `${brand} 知识库`,
          h1: (brand) => `${brand} 知识库（Public Portal）`,
          desc: "数据来自 `GET /public/kb/docs`，支持关键词搜索与分类过滤。",
          qPh: "搜索：标题/内容/标签（search）",
          catPh: "分类（category，可选）",
          searchBtn: "搜索",
          emptyTitle: "无结果",
          emptyHint: "调整关键词或分类再试。",
          category: "分类",
          created: "创建",
          id: "ID",
          tags: "标签",
          reqFail: (code) => `请求失败: ${code}`,
        },
        "en-US": {
          title: (brand) => `${brand} Knowledge Base`,
          h1: (brand) => `${brand} Knowledge Base (Public Portal)`,
          desc: "Data from `GET /public/kb/docs`, with search & category filter.",
          qPh: "Search: title/content/tags (search)",
          catPh: "Category (optional)",
          searchBtn: "Search",
          emptyTitle: "No results",
          emptyHint: "Try another keyword or category.",
          category: "Category",
          created: "Created",
          id: "ID",
          tags: "Tags",
          reqFail: (code) => `Request failed: ${code}`,
        },
      };

      function normalizeLocale(loc) {
        if (!loc) return "";
        loc = String(loc).trim();
        if (loc === "zh" || loc === "zh-CN") return "zh-CN";
        if (loc === "en" || loc === "en-US") return "en-US";
        return loc;
      }

      function pickLocale(portal) {
        const urlLoc = normalizeLocale(new URLSearchParams(location.search).get("lang"));
        if (urlLoc && I18N[urlLoc]) return urlLoc;
        const portalLoc = normalizeLocale(portal?.default_locale);
        if (portalLoc && I18N[portalLoc]) return portalLoc;
        const nav = normalizeLocale(navigator.language || "");
        if (nav && I18N[nav]) return nav;
        return "zh-CN";
      }

      async function loadPortalConfig() {
        const res = await fetch("/public/portal/config", { headers: { Accept: "application/json" } }).catch(() => null);
        if (!res || !res.ok) return null;
        return await res.json().catch(() => null);
      }

      function applyBranding(portal) {
        if (!portal) return;
        const root = document.documentElement;
        if (portal.primary_color) root.style.setProperty("--brand-primary", portal.primary_color);
        if (portal.secondary_color) root.style.setProperty("--brand-secondary", portal.secondary_color);
      }

      function applyI18n(locale, portal) {
        const t = I18N[locale] || I18N["zh-CN"];
        const brand = portal?.brand_name || "Servify";
        document.documentElement.lang = locale;
        document.title = t.title(brand);
        $("h1").textContent = t.h1(brand);
        $("desc").textContent = t.desc;
        $("q").placeholder = t.qPh;
        $("category").placeholder = t.catPh;
        $("btn").textContent = t.searchBtn;
        return t;
      }

      function setError(msg) {
        if (!msg) { errEl.style.display = "none"; errEl.textContent = ""; return; }
        errEl.style.display = "block";
        errEl.textContent = msg;
      }

      function renderDocs(docs, t) {
        listEl.innerHTML = "";
        if (!docs || docs.length === 0) {
          listEl.innerHTML = `<div class="card"><h3>${escapeHtml(t.emptyTitle)}</h3><div class="meta">${escapeHtml(t.emptyHint)}</div></div>`;
          return;
        }
        for (const d of docs) {
          const tags = (d.tags || "").toString().trim();
          const cat = (d.category || "").toString().trim();
          const created = d.created_at ? new Date(d.created_at).toLocaleString(document.documentElement.lang || undefined) : "";
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h3>${escapeHtml(d.title || "(untitled)")}</h3>
            <div class="meta">
              ${cat ? `${escapeHtml(t.category)}: ${escapeHtml(cat)} · ` : ""}${created ? `${escapeHtml(t.created)}: ${escapeHtml(created)} · ` : ""}${escapeHtml(t.id)}: ${d.id}
            </div>
            <div class="content">${escapeHtml(d.content || "")}</div>
            ${tags ? `<div class="tags">${escapeHtml(t.tags)}: ${escapeHtml(tags)}</div>` : ""}
          `;
          listEl.appendChild(card);
        }
      }

      function escapeHtml(s) {
        return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          "\"": "&quot;",
          "'": "&#39;",
        }[c]));
      }

      async function fetchDocs(t) {
        setError("");
        const params = new URLSearchParams();
        const q = $("q").value.trim();
        const category = $("category").value.trim();
        if (q) params.set("search", q);
        if (category) params.set("category", category);
        params.set("page", "1");
        params.set("page_size", "20");

        const url = "/public/kb/docs?" + params.toString();
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(body?.message || body?.error || t.reqFail(res.status));
        }
        renderDocs(body?.data || [], t);
      }

      (async function boot() {
        const portal = await loadPortalConfig();
        applyBranding(portal);
        const locale = pickLocale(portal);
        const t = applyI18n(locale, portal);

        $("btn").addEventListener("click", () => fetchDocs(t).catch((e) => setError(e.message)));
        $("q").addEventListener("keydown", (e) => { if (e.key === "Enter") $("btn").click(); });
        $("category").addEventListener("keydown", (e) => { if (e.key === "Enter") $("btn").click(); });

        fetchDocs(t).catch((e) => setError(e.message));
      })();
    </script>
  </body>
</html>
