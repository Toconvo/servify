<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Servify WebSocket Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 20px; }
    #log { border: 1px solid #ddd; padding: 10px; height: 280px; overflow: auto; background: #fafafa; }
    .row { margin-bottom: 10px; }
    input[type=text] { width: 70%; padding: 6px; }
    button { padding: 6px 10px; }
  </style>
  <script>
    let ws;
    const log = (msg) => {
      const el = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    };

    function connect() {
      const sessionId = document.getElementById('session').value || `demo_${Date.now()}`;
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${proto}://${location.host}/api/v1/ws?session_id=${encodeURIComponent(sessionId)}`;
      ws = new WebSocket(wsUrl);
      log(`连接至 ${wsUrl}`);
      ws.onopen = () => log('WebSocket 已连接');
      ws.onclose = () => log('WebSocket 已关闭');
      ws.onerror = (e) => log('WebSocket 错误');
      ws.onmessage = (evt) => {
        try { log(`收到: ${evt.data}`); }
        catch (e) { log(`收到消息`); }
      };
    }
    function sendMsg() {
      const text = document.getElementById('msg').value;
      if (!ws || ws.readyState !== 1) return log('连接未就绪');
      const payload = { type: 'text-message', data: { content: text } };
      ws.send(JSON.stringify(payload));
      log(`发送: ${JSON.stringify(payload)}`);
    }
  </script>
  </head>
  <body>
    <h2>Servify WebSocket Demo</h2>
    <div class="row">
      会话ID: <input id="session" type="text" placeholder="留空则自动生成" />
      <button onclick="connect()">连接</button>
    </div>
    <div class="row">
      消息: <input id="msg" type="text" placeholder="输入要发送的文本" />
      <button onclick="sendMsg()">发送</button>
    </div>
    <div id="log"></div>
  </body>
  </html>
